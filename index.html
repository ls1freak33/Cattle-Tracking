<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Cattle Tracker</title>

<style>
  :root{
    --bg:#f2f2f2;
    --card:#ffffff;
    --text:#111;
    --muted:#666;
    --primary:#2e7d32;
    --secondary:#0277bd;
    --danger:#c62828;
    --warn:#ef6c00;
    --line:#e5e5e5;
    --pill:#e8f5e9;
    --pillActive:#c8e6c9;
  }
  body{margin:0;padding:14px;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text)}
  h1{margin:8px 0 10px;text-align:center;font-size:34px}
  h2{margin:6px 0 10px}
  h3{margin:10px 0 8px}
  .sub{margin-top:-2px;text-align:center;color:var(--muted);font-size:13px}
  button{width:100%;padding:14px;margin:6px 0;font-size:16px;border-radius:10px;border:none;color:#fff}
  .primary{background:var(--primary)}
  .secondary{background:var(--secondary)}
  .danger{background:var(--danger)}
  .warn{background:var(--warn)}
  .ghost{background:#fff;color:var(--secondary);border:1px solid var(--secondary)}
  .small{width:80%;margin:10px auto}
  input,select,textarea{
    width:100%;
    padding:12px;
    margin:6px 0;
    border-radius:8px;
    border:1px solid #ccc;
    background:#fff;
    box-sizing:border-box;
    font-size:16px;
  }
  textarea{min-height:80px;resize:vertical}
  .card{
    background:var(--card);
    padding:15px;
    border-radius:12px;
    margin-top:12px;
    box-shadow:0 1px 0 rgba(0,0,0,.03);
  }
  .listItem{
    background:var(--card);
    padding:14px;
    border-radius:12px;
    margin:10px 0;
    cursor:pointer;
    border:1px solid rgba(0,0,0,.04);
  }
  .listItem .title{font-weight:bold}
  .listItem .meta{color:var(--muted);margin-top:4px;font-size:13px}
  .row{display:flex;gap:10px}
  .row > div{flex:1}
  .hidden{display:none}
  .pill{
    background:var(--pill);
    padding:10px;
    border-radius:8px;
    margin:6px 0;
    border:1px solid rgba(0,0,0,.04);
  }
  .pill.active{background:var(--pillActive)}
  .hr{height:1px;background:var(--line);margin:12px 0}
  .label{font-size:12px;color:var(--muted);margin-top:8px}
  .kvs{line-height:1.55}
  .kvs b{display:inline-block;min-width:86px}
  .topSearch{
    margin:10px 0 0;
    display:flex;
    gap:8px;
    align-items:center;
  }
  .topSearch input{margin:0}
  .topSearch button{margin:0;width:auto;white-space:nowrap;padding:12px 14px;border-radius:10px}
  .note{font-size:13px;color:var(--muted)}
  .lockNote{font-size:12px;color:var(--muted);margin-top:6px}

  /* Photo grid */
  .photoGrid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:10px;
    margin-top:10px;
  }
  .thumb{
    width:100%;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius:10px;
    border:1px solid rgba(0,0,0,.08);
    background:#eee;
  }
  .thumbWrap{position:relative}
  .thumbDel{
    position:absolute;
    top:6px;
    right:6px;
    background:rgba(198,40,40,0.95);
    color:#fff;
    border:none;
    border-radius:999px;
    width:28px;
    height:28px;
    font-size:18px;
    line-height:28px;
    padding:0;
    cursor:pointer;
  }

  /* Modal */
  .modalOverlay{
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.7);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:14px;
    z-index:9999;
  }
  .modal{
    background:#111;
    border-radius:14px;
    width:100%;
    max-width:520px;
    overflow:hidden;
  }
  .modal img{
    width:100%;
    height:auto;
    display:block;
  }
  .modalBar{
    display:flex;
    gap:10px;
    padding:10px;
    background:#000;
  }
  .modalBar button{
    margin:0;
    padding:12px;
    font-size:15px;
    border-radius:10px;
  }
</style>
</head>

<body>
  <h1>üêÑ Cattle Tracker</h1>
  <div class="sub">Offline-ready ‚Ä¢ Data & photos stored on this device</div>

  <div id="screens">

    <!-- HOME -->
    <div id="home">
      <div class="topSearch">
        <input id="globalSearch" placeholder="Search by Tag # (all active)" />
        <button class="secondary" onclick="searchByTag()">Search</button>
      </div>

      <button class="primary" onclick="show('calves')">Calves</button>
      <button class="secondary" onclick="show('heifers')">Heifers</button>
      <button class="secondary" onclick="show('cows')">Cows</button>
      <button class="secondary" onclick="show('bulls')">Bulls</button>
      <button class="secondary" onclick="show('sold')">Sold / History</button>

      <div class="card">
        <div class="note">
          Photos are saved in your browser storage (IndexedDB). If you clear Safari website data, it clears the app.
        </div>
      </div>
    </div>

    <!-- CALVES LIST -->
    <div id="calves" class="hidden">
      <button class="primary" onclick="openAdd('calf')">‚ûï Add Calf</button>

      <div class="topSearch">
        <input id="calfSearch" placeholder="Search calves by Tag #" oninput="refresh()" />
        <button class="ghost" onclick="document.getElementById('calfSearch').value='';refresh()">Clear</button>
      </div>

      <div id="calfList"></div>
      <button class="secondary" onclick="goBack('home')">Back</button>
    </div>

    <!-- HEIFERS LIST -->
    <div id="heifers" class="hidden">
      <button class="primary" onclick="openAdd('heifer')">‚ûï Add Heifer</button>

      <div class="topSearch">
        <input id="heiferSearch" placeholder="Search heifers by Tag #" oninput="refresh()" />
        <button class="ghost" onclick="document.getElementById('heiferSearch').value='';refresh()">Clear</button>
      </div>

      <div id="heiferList"></div>
      <button class="secondary" onclick="goBack('home')">Back</button>
    </div>

    <!-- COWS LIST -->
    <div id="cows" class="hidden">
      <button class="primary" onclick="openAdd('cow')">‚ûï Add Cow</button>

      <div class="topSearch">
        <input id="cowSearch" placeholder="Search cows by Tag #" oninput="refresh()" />
        <button class="ghost" onclick="document.getElementById('cowSearch').value='';refresh()">Clear</button>
      </div>

      <div id="cowList"></div>
      <button class="secondary" onclick="goBack('home')">Back</button>
    </div>

    <!-- BULLS LIST -->
    <div id="bulls" class="hidden">
      <button class="primary" onclick="openAdd('bull')">‚ûï Add Bull</button>

      <div class="topSearch">
        <input id="bullSearch" placeholder="Search bulls by Tag #" oninput="refresh()" />
        <button class="ghost" onclick="document.getElementById('bullSearch').value='';refresh()">Clear</button>
      </div>

      <div id="bullList"></div>
      <button class="secondary" onclick="goBack('home')">Back</button>
    </div>

    <!-- SOLD / HISTORY -->
    <div id="sold" class="hidden">
      <div class="topSearch">
        <input id="soldSearch" placeholder="Search sold/history by Tag #" oninput="refresh()" />
        <button class="ghost" onclick="document.getElementById('soldSearch').value='';refresh()">Clear</button>
      </div>

      <div id="soldList"></div>
      <button class="secondary" onclick="goBack('home')">Back</button>
    </div>

    <!-- ADD SCREEN -->
    <div id="add" class="card hidden"></div>

    <!-- DETAIL SCREEN -->
    <div id="detail" class="card hidden"></div>

  </div>

  <!-- Photo Modal -->
  <div id="modalOverlay" class="modalOverlay hidden" onclick="closeModal(event)">
    <div class="modal" onclick="event.stopPropagation()">
      <img id="modalImg" alt="Photo"/>
      <div class="modalBar">
        <button class="secondary" onclick="closeModal()">Close</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   IndexedDB for Photos
   - Store: "photos"
   - Key: photoId (number)
   - Value: { photoId, animalId, blob, createdAt }
========================= */
const DB_NAME = 'cattle_tracker_db';
const DB_VERSION = 1;
let dbPromise = null;

function openPhotoDB(){
  if(dbPromise) return dbPromise;
  dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = () => {
      const db = req.result;
      if(!db.objectStoreNames.contains('photos')){
        const store = db.createObjectStore('photos', { keyPath: 'photoId' });
        store.createIndex('byAnimal', 'animalId', { unique: false });
      }
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
  });
  return dbPromise;
}

async function putPhotoRecord(record){
  const db = await openPhotoDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('photos', 'readwrite');
    tx.objectStore('photos').put(record);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function getPhotoRecord(photoId){
  const db = await openPhotoDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('photos', 'readonly');
    const req = tx.objectStore('photos').get(photoId);
    req.onsuccess = () => resolve(req.result || null);
    req.onerror = () => reject(req.error);
  });
}

async function deletePhotoRecord(photoId){
  const db = await openPhotoDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('photos', 'readwrite');
    tx.objectStore('photos').delete(photoId);
    tx.oncomplete = () => resolve(true);
    tx.onerror = () => reject(tx.error);
  });
}

async function getPhotoIdsForAnimal(animalId){
  const db = await openPhotoDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('photos', 'readonly');
    const idx = tx.objectStore('photos').index('byAnimal');
    const req = idx.getAllKeys(animalId);
    req.onsuccess = () => resolve(req.result || []);
    req.onerror = () => reject(req.error);
  });
}

function blobToURL(blob){
  return URL.createObjectURL(blob);
}

/* =========================
   Storage + Utilities
========================= */
let animals = JSON.parse(localStorage.getItem('animals') || '[]');
let screenStack = [];
let editingId = null;
let draft = null;
let selectedVaxIndex = null;
let originalDraftSnapshot = null;

function saveAll(){
  localStorage.setItem('animals', JSON.stringify(animals));
}

function uid(){
  return Date.now() + Math.floor(Math.random()*1000);
}

function byId(id){
  return animals.find(a => a.id === id);
}

function safeTag(a){
  return (a.tag && String(a.tag).trim().length) ? String(a.tag).trim() : "‚Äî";
}

function roleLabel(role){
  return role.toUpperCase();
}

function fmtDam(damId){
  if(!damId) return "Unknown";
  const d = byId(Number(damId));
  return d ? ("Cow " + safeTag(d)) : "Unknown";
}

function fmtSire(sireId){
  if(!sireId) return "Unknown";
  const s = byId(Number(sireId));
  return s ? ("Bull " + safeTag(s)) : "Unknown";
}

function isPromotedLocked(a){
  return (a.lockAfterPromote === true) && (a.role === 'heifer' || a.role === 'cow');
}

function hasUnsavedChanges(){
  if(!draft || !originalDraftSnapshot) return false;
  return JSON.stringify(draft) !== JSON.stringify(originalDraftSnapshot);
}

function confirmIfUnsaved(next){
  if(hasUnsavedChanges()){
    if(!confirm("You have unsaved changes. Discard them?")) return;
  }
  next();
}

/* =========================
   Navigation
========================= */
function show(id){
  document.querySelectorAll("#screens > div").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  refresh();
}

function goBack(fallback){
  const current = getCurrentScreenId();
  if(current === 'detail' || current === 'add'){
    return confirmIfUnsaved(() => popScreen(fallback));
  }
  popScreen(fallback);
}

function getCurrentScreenId(){
  const all = Array.from(document.querySelectorAll("#screens > div"));
  const shown = all.find(d => !d.classList.contains('hidden'));
  return shown ? shown.id : 'home';
}

function pushScreen(id){
  const current = getCurrentScreenId();
  if(current) screenStack.push(current);
  show(id);
}

function popScreen(fallback){
  const prev = screenStack.pop() || fallback || 'home';
  show(prev);
}

/* =========================
   Lists + Search
========================= */
function normalize(s){ return String(s || '').trim().toLowerCase(); }

function matchesTag(a, query){
  if(!query) return true;
  return normalize(a.tag).includes(normalize(query));
}

function shortDesc(a){
  const d = (a.description || "").trim();
  return d ? d : "";
}

function refresh(){
  const calfQ = document.getElementById('calfSearch')?.value || '';
  const heiferQ = document.getElementById('heiferSearch')?.value || '';
  const cowQ = document.getElementById('cowSearch')?.value || '';
  const bullQ = document.getElementById('bullSearch')?.value || '';
  const soldQ = document.getElementById('soldSearch')?.value || '';

  const calves = animals.filter(a => a.role==='calf' && !a.sold).filter(a => matchesTag(a, calfQ));
  calfList.innerHTML = calves.map(renderListItem).join('') || `<div class="card">No calves yet.</div>`;

  const heifers = animals.filter(a => a.role==='heifer' && !a.sold).filter(a => matchesTag(a, heiferQ));
  heiferList.innerHTML = heifers.map(renderListItem).join('') || `<div class="card">No heifers yet.</div>`;

  const cows = animals.filter(a => a.role==='cow' && !a.sold).filter(a => matchesTag(a, cowQ));
  cowList.innerHTML = cows.map(renderListItem).join('') || `<div class="card">No cows yet.</div>`;

  const bulls = animals.filter(a => a.role==='bull' && !a.sold).filter(a => matchesTag(a, bullQ));
  bullList.innerHTML = bulls.map(renderListItem).join('') || `<div class="card">No bulls yet.</div>`;

  const sold = animals.filter(a => a.sold).filter(a => matchesTag(a, soldQ));
  soldList.innerHTML = sold.map(renderListItem).join('') || `<div class="card">No sold/history yet.</div>`;
}

function renderListItem(a){
  const metaBits = [];
  const desc = shortDesc(a);
  const photoCount = Array.isArray(a.photoIds) ? a.photoIds.length : 0;

  if(a.role === 'calf'){
    metaBits.push(a.sex || '');
    metaBits.push(fmtDam(a.damId));
    metaBits.push(fmtSire(a.sireId));
    if(desc) metaBits.push(desc);
  }
  if(a.role === 'heifer'){
    metaBits.push("Born " + (a.birth || "‚Äî"));
    if(desc) metaBits.push(desc);
  }
  if(a.role === 'cow'){
    const herCalves = animals.filter(x => !x.sold && x.damId && Number(x.damId)===a.id);
    metaBits.push("Calves: " + herCalves.length);
    if(desc) metaBits.push(desc);
  }
  if(a.role === 'bull'){
    const his = animals.filter(x => !x.sold && x.sireId && Number(x.sireId)===a.id);
    metaBits.push("Sired: " + his.length);
    if(desc) metaBits.push(desc);
  }
  if(a.sold) metaBits.push("SOLD");
  if(photoCount) metaBits.push("Photos: " + photoCount);

  return `
    <div class="listItem" onclick="openDetail(${a.id})">
      <div class="title">${roleLabel(a.role)} | Tag ${safeTag(a)}</div>
      <div class="meta">${metaBits.filter(Boolean).join(" ‚Ä¢ ")}</div>
    </div>
  `;
}

function searchByTag(){
  const q = normalize(globalSearch.value);
  if(!q){ alert("Enter a tag number to search."); return; }
  const found = animals.find(a => !a.sold && normalize(a.tag) === q);
  if(!found){
    alert("No active animal found with that exact tag. (Try partial search inside a tab.)");
    return;
  }
  openDetail(found.id);
}

/* =========================
   Add Forms
========================= */
function openAdd(role){
  confirmIfUnsaved(() => {
    editingId = null;
    draft = null;
    selectedVaxIndex = null;
    originalDraftSnapshot = null;

    const addDiv = document.getElementById('add');
    addDiv.innerHTML = renderAddForm(role);
    pushScreen('add');
    populateSelectsForAdd(role);
  });
}

function populateSelectsForAdd(role){
  if(role === 'calf'){
    const cowSel = document.getElementById('addDam');
    const sireSel = document.getElementById('addSire');

    const cowOptions = animals.filter(a => a.role==='cow' && !a.sold)
      .map(c => `<option value="${c.id}">Cow ${safeTag(c)}</option>`).join('');

    cowSel.innerHTML = `<option value="">Unknown (optional)</option>` + cowOptions;

    const bullOptions = animals.filter(a => a.role==='bull' && !a.sold)
      .map(b => `<option value="${b.id}">Bull ${safeTag(b)}</option>`).join('');

    sireSel.innerHTML = `<option value="">Unknown (optional)</option>` + bullOptions;
  }
}

function renderAddForm(role){
  if(role === 'calf'){
    return `
      <h2>Add Calf</h2>

      <div class="row">
        <div>
          <div class="label">Sex</div>
          <select id="addSex">
            <option value="Female">Female</option>
            <option value="Male">Male</option>
          </select>
        </div>
        <div>
          <div class="label">Born</div>
          <input id="addBirth" type="date"/>
        </div>
      </div>

      <div class="label">Tag (optional)</div>
      <input id="addTag" placeholder="e.g. 24"/>

      <div class="label">Tag Color (type it)</div>
      <input id="addColor" placeholder="e.g. Red"/>

      <div class="label">Description</div>
      <input id="addDesc" placeholder="e.g. Black, Grey, Motley face"/>

      <div class="label">Cow (Dam) (optional)</div>
      <select id="addDam"><option value="">Unknown (optional)</option></select>

      <div class="label">Bull (Sire) (optional)</div>
      <select id="addSire"><option value="">Unknown (optional)</option></select>

      <button class="primary" onclick="createCalf()">Save Calf</button>
      <button class="secondary" onclick="goBack('calves')">Cancel</button>
    `;
  }

  if(role === 'heifer'){
    return `
      <h2>Add Heifer (Existing)</h2>

      <div class="label">Tag #</div>
      <input id="addHeiferTag" placeholder="e.g. 12"/>

      <div class="label">Tag Color</div>
      <input id="addHeiferColor" placeholder="e.g. Yellow"/>

      <div class="label">Born (optional)</div>
      <input id="addHeiferBirth" type="date"/>

      <div class="label">Description</div>
      <input id="addHeiferDesc" placeholder="e.g. Grey, Motley face"/>

      <button class="primary" onclick="createHeifer()">Save Heifer</button>
      <button class="secondary" onclick="goBack('heifers')">Cancel</button>
    `;
  }

  if(role === 'cow'){
    return `
      <h2>Add Cow (Existing)</h2>

      <div class="label">Tag #</div>
      <input id="addCowTag" placeholder="e.g. 42"/>

      <div class="label">Tag Color</div>
      <input id="addCowColor" placeholder="e.g. Yellow"/>

      <div class="label">Born (optional)</div>
      <input id="addCowBirth" type="date"/>

      <div class="label">Description</div>
      <input id="addCowDesc" placeholder="e.g. Black, Grey"/>

      <button class="primary" onclick="createCow()">Save Cow</button>
      <button class="secondary" onclick="goBack('cows')">Cancel</button>
    `;
  }

  if(role === 'bull'){
    return `
      <h2>Add Bull</h2>

      <div class="label">Bull # (tag)</div>
      <input id="addBullTag" placeholder="e.g. 25"/>

      <div class="label">Description</div>
      <input id="addBullDesc" placeholder="e.g. Black, big frame"/>

      <div class="label">Notes (optional)</div>
      <textarea id="addBullNotes" placeholder="Anything you want to remember about this bull"></textarea>

      <button class="primary" onclick="createBull()">Save Bull</button>
      <button class="secondary" onclick="goBack('bulls')">Cancel</button>
    `;
  }

  return `<div>Unknown add type.</div>`;
}

function baseAnimal(){
  return {
    id: uid(),
    sold: false,
    tag: "",
    color: "",
    description: "",
    birth: "",
    damId: null,
    sireId: null,
    cut: null,
    vaccines: [],
    notes: "",
    lockAfterPromote: false,
    photoIds: [] // photoId list (points to IndexedDB)
  };
}

function createCalf(){
  const a = baseAnimal();
  a.role = 'calf';
  a.sex = addSex.value;
  a.birth = addBirth.value || "";
  a.tag = addTag.value || "";
  a.color = addColor.value || "";
  a.description = (document.getElementById('addDesc').value || "");
  a.damId = addDam.value ? Number(addDam.value) : null;
  a.sireId = addSire.value ? Number(addSire.value) : null;
  a.cut = (a.sex === 'Male') ? 'No' : null;
  a.lockAfterPromote = false;
  animals.push(a);
  saveAll();
  show('calves');
}

function createHeifer(){
  const a = baseAnimal();
  a.role = 'heifer';
  a.sex = 'Female';
  a.tag = addHeiferTag.value || "";
  a.color = addHeiferColor.value || "";
  a.birth = addHeiferBirth.value || "";
  a.description = addHeiferDesc.value || "";
  a.lockAfterPromote = false;
  animals.push(a);
  saveAll();
  show('heifers');
}

function createCow(){
  const a = baseAnimal();
  a.role = 'cow';
  a.sex = 'Female';
  a.tag = addCowTag.value || "";
  a.color = addCowColor.value || "";
  a.birth = addCowBirth.value || "";
  a.description = addCowDesc.value || "";
  a.lockAfterPromote = false;
  animals.push(a);
  saveAll();
  show('cows');
}

function createBull(){
  const a = baseAnimal();
  a.role = 'bull';
  a.sex = 'Male';
  a.tag = addBullTag.value || "";
  a.description = addBullDesc.value || "";
  a.notes = addBullNotes.value || "";
  a.lockAfterPromote = false;
  animals.push(a);
  saveAll();
  show('bulls');
}

/* =========================
   Detail Screen + Photos
========================= */
function openDetail(id){
  confirmIfUnsaved(() => {
    editingId = id;
    const a = byId(id);
    draft = JSON.parse(JSON.stringify(a));
    selectedVaxIndex = null;
    originalDraftSnapshot = JSON.parse(JSON.stringify(draft));
    renderDetail();
    pushScreen('detail');
  });
}

async function renderPhotoGrid(animal){
  // Always sync ids from DB (in case)
  const ids = Array.isArray(animal.photoIds) ? animal.photoIds : [];
  if(!ids.length){
    return `<div class="pill">No photos yet.</div>`;
  }

  // Create thumbs by loading each blob and making object URL
  let html = `<div class="photoGrid">`;
  for(const pid of ids){
    const rec = await getPhotoRecord(pid);
    if(!rec || !rec.blob) continue;
    const url = blobToURL(rec.blob);
    html += `
      <div class="thumbWrap">
        <img class="thumb" src="${url}" alt="photo" onclick="openModalByPhotoId(${pid})"/>
        <button class="thumbDel" onclick="event.stopPropagation();deletePhotoFromAnimal(${pid})">√ó</button>
      </div>
    `;
  }
  html += `</div>`;
  return html;
}

async function openModalByPhotoId(photoId){
  const rec = await getPhotoRecord(photoId);
  if(!rec || !rec.blob){
    alert("Photo not found.");
    return;
  }
  const url = blobToURL(rec.blob);
  modalImg.src = url;
  modalOverlay.classList.remove('hidden');
}

function closeModal(){
  modalOverlay.classList.add('hidden');
  modalImg.src = "";
}

async function addPhotosFromInput(){
  const input = document.getElementById('photoInput');
  if(!input || !input.files || !input.files.length) return;

  const animalIndex = animals.findIndex(x => x.id === editingId);
  if(animalIndex === -1){ alert("Animal missing."); return; }

  // Add each photo to IndexedDB + attach photoId to animal record immediately
  for(const file of input.files){
    const photoId = uid();
    await putPhotoRecord({
      photoId,
      animalId: editingId,
      blob: file,
      createdAt: Date.now()
    });

    if(!Array.isArray(animals[animalIndex].photoIds)) animals[animalIndex].photoIds = [];
    animals[animalIndex].photoIds.push(photoId);
  }

  saveAll();

  // Keep draft in sync too (so UI updates)
  const fresh = byId(editingId);
  draft.photoIds = JSON.parse(JSON.stringify(fresh.photoIds || []));

  // reset chooser
  input.value = "";

  // re-render
  originalDraftSnapshot = JSON.parse(JSON.stringify(draft));
  renderDetail();
}

async function deletePhotoFromAnimal(photoId){
  if(!confirm("Delete this photo?")) return;

  const idx = animals.findIndex(x => x.id === editingId);
  if(idx === -1) return;

  // Remove link
  animals[idx].photoIds = (animals[idx].photoIds || []).filter(id => id !== photoId);

  // Delete blob
  await deletePhotoRecord(photoId);

  saveAll();

  // Sync draft
  const fresh = byId(editingId);
  draft.photoIds = JSON.parse(JSON.stringify(fresh.photoIds || []));

  originalDraftSnapshot = JSON.parse(JSON.stringify(draft));
  renderDetail();
}

async function renderDetail(){
  const a = draft;
  const locked = isPromotedLocked(a);

  const herCalves = (a.role === 'cow')
    ? animals.filter(x => !x.sold && x.damId && Number(x.damId) === a.id)
    : [];
  const hisCalves = (a.role === 'bull')
    ? animals.filter(x => !x.sold && x.sireId && Number(x.sireId) === a.id)
    : [];

  const cows = animals.filter(x => x.role==='cow' && !x.sold);
  const bulls = animals.filter(x => x.role==='bull' && !x.sold);

  const damSelect = (a.role === 'calf' && !locked)
    ? `
      <div class="label">Cow (Dam)</div>
      <select id="eDam">
        <option value="">Unknown (optional)</option>
        ${cows.map(c => `<option value="${c.id}" ${a.damId===c.id?'selected':''}>Cow ${safeTag(c)}</option>`).join('')}
      </select>`
    : `<div class="kvs"><b>Dam:</b> ${fmtDam(a.damId)}</div>`;

  const sireSelect = (a.role === 'calf' && !locked)
    ? `
      <div class="label">Bull (Sire)</div>
      <select id="eSire">
        <option value="">Unknown (optional)</option>
        ${bulls.map(b => `<option value="${b.id}" ${a.sireId===b.id?'selected':''}>Bull ${safeTag(b)}</option>`).join('')}
      </select>`
    : `<div class="kvs"><b>Sire:</b> ${fmtSire(a.sireId)}</div>`;

  const cutUI = (a.sex === 'Male' && a.role === 'calf')
    ? `
      <div class="label">Cut</div>
      <select id="eCut">
        <option value="No" ${a.cut==='No'?'selected':''}>No</option>
        <option value="Yes" ${a.cut==='Yes'?'selected':''}>Yes</option>
      </select>
    ` : '';

  const promoteUI = (a.role === 'calf' && a.sex === 'Female')
    ? `<button class="secondary" onclick="promote()">Promote to Heifer</button>`
    : (a.role === 'heifer')
      ? `<button class="secondary" onclick="promote()">Promote to Cow</button>`
      : '';

  const soldBtnText = a.sold ? "Unmark Sold (Restore)" : "Mark Sold";
  const soldBtnClass = a.sold ? "secondary" : "danger";

  const canEditDescription =
    (a.role === 'calf') ||
    (a.role === 'bull') ||
    ((a.role === 'heifer' || a.role === 'cow') && !locked);

  // Vaccines UI
  const v = Array.isArray(a.vaccines) ? a.vaccines : [];
  const vList = v.length
    ? v.map((vx, idx) => `
      <div class="pill ${selectedVaxIndex===idx?'active':''}" onclick="selectVax(${idx})">
        ${escapeHtml(vx.date || '‚Äî')}${vx.note ? " ‚Äî " + escapeHtml(vx.note) : ""}
      </div>
    `).join('')
    : `<div class="pill">None</div>`;

  const selected = (selectedVaxIndex !== null && v[selectedVaxIndex])
    ? v[selectedVaxIndex]
    : {date:'', note:''};

  const photoGridHTML = await renderPhotoGrid(a);

  detail.innerHTML = `
    <h2>${roleLabel(a.role)}</h2>

    <div class="label">Tag</div>
    <input id="eTag" value="${escapeHtml(a.tag || '')}" placeholder="(optional)"/>

    <div class="label">Tag Color</div>
    <input id="eColor" value="${escapeHtml(a.color || '')}" placeholder="(type it)"/>

    <div class="label">Born</div>
    <input id="eBirth" type="date" value="${escapeHtml(a.birth || '')}" />

    <div class="label">Description</div>
    ${canEditDescription
      ? `<input id="eDesc" value="${escapeHtml(a.description || '')}" placeholder="e.g. Black, Grey, Motley face"/>`
      : `<div class="pill">${escapeHtml(a.description || '‚Äî')}</div>
         <div class="lockNote">Description is locked after promotion.</div>`
    }

    <div class="hr"></div>

    <div class="kvs">
      <b>Sex:</b> ${a.sex || '‚Äî'}<br/>
      ${damSelect}
      ${sireSelect}
    </div>

    ${cutUI}

    <div class="hr"></div>

    <h3>Vaccines</h3>
    ${vList}

    <div class="label">Vaccine Date</div>
    <input id="vDate" type="date" value="${escapeHtml(selected.date || '')}"/>

    <div class="label">Vaccine Note (optional)</div>
    <input id="vNote" value="${escapeHtml(selected.note || '')}" placeholder="e.g. Normak"/>

    <button class="secondary" onclick="addOrUpdateVax()">Add / Update Vaccine</button>
    <button class="danger" onclick="deleteVax()">Delete Vaccine</button>

    <div class="hr"></div>

    <h3>Photos</h3>
    <div class="note">Tap a photo to view large. Photos save immediately to this device.</div>
    <input id="photoInput" type="file" accept="image/*" multiple capture="environment" />
    <button class="secondary" onclick="addPhotosFromInput()">Add Selected Photos</button>
    ${photoGridHTML}

    <div class="hr"></div>

    <div class="label">Notes</div>
    <textarea id="eNotes" placeholder="Optional notes...">${escapeHtml(a.notes || '')}</textarea>

    ${a.role === 'cow' ? `
      <div class="hr"></div>
      <h3>Calves (Produced: ${herCalves.length})</h3>
      ${herCalves.length ? herCalves.map(c => `
        <div class="pill" onclick="openDetail(${c.id})">
          ${c.role.toUpperCase()} ‚Ä¢ Tag ${safeTag(c)} ‚Ä¢ ${c.sex} ‚Ä¢ Born ${c.birth||'‚Äî'}
        </div>
      `).join('') : `<div class="pill">None yet.</div>`}
    ` : ''}

    ${a.role === 'bull' ? `
      <div class="hr"></div>
      <h3>Calves Sired (${hisCalves.length})</h3>
      ${hisCalves.length ? hisCalves.map(c => `
        <div class="pill" onclick="openDetail(${c.id})">
          ${c.role.toUpperCase()} ‚Ä¢ Tag ${safeTag(c)} ‚Ä¢ ${c.sex} ‚Ä¢ Born ${c.birth||'‚Äî'}
        </div>
      `).join('') : `<div class="pill">None yet.</div>`}
    ` : ''}

    <div class="hr"></div>

    <button class="primary small" onclick="saveChanges()">Save Changes</button>
    ${promoteUI}
    <button class="${soldBtnClass}" onclick="toggleSold()">${soldBtnText}</button>
    <button class="warn" onclick="deleteAnimal()">Delete (Permanent)</button>
    <button class="secondary" onclick="goBack('home')">Back</button>

    <div class="note">Back discards unsaved changes. Use ‚ÄúSave Changes‚Äù to keep edits.</div>
  `;
}

function escapeHtml(s){
  return String(s||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;')
    .replaceAll('"','&quot;')
    .replaceAll("'","&#039;");
}

/* =========================
   Vaccines (draft until Save)
========================= */
function selectVax(idx){
  selectedVaxIndex = idx;
  renderDetail();
}

function addOrUpdateVax(){
  const date = document.getElementById('vDate').value;
  const note = document.getElementById('vNote').value || "";
  if(!date){ alert("Please select a vaccine date."); return; }

  if(!draft.vaccines) draft.vaccines = [];

  if(selectedVaxIndex === null){
    draft.vaccines.push({date, note});
  }else{
    draft.vaccines[selectedVaxIndex] = {date, note};
  }

  selectedVaxIndex = null;
  renderDetail();
}

function deleteVax(){
  if(selectedVaxIndex === null){
    alert("Tap a vaccine in the list first to select it.");
    return;
  }
  if(!confirm("Delete this vaccine entry?")) return;

  draft.vaccines.splice(selectedVaxIndex, 1);
  selectedVaxIndex = null;
  renderDetail();
}

/* =========================
   Save / Promote / Sold / Delete
========================= */
function saveChanges(){
  const a = draft;

  a.tag = document.getElementById('eTag').value || "";
  a.color = document.getElementById('eColor').value || "";
  a.birth = document.getElementById('eBirth').value || "";
  a.notes = document.getElementById('eNotes').value || "";

  const eDesc = document.getElementById('eDesc');
  if(eDesc) a.description = eDesc.value || "";

  if(a.role === 'calf'){
    const damSel = document.getElementById('eDam');
    const sireSel = document.getElementById('eSire');
    if(damSel) a.damId = damSel.value ? Number(damSel.value) : null;
    if(sireSel) a.sireId = sireSel.value ? Number(sireSel.value) : null;

    if(a.sex === 'Male'){
      const cutSel = document.getElementById('eCut');
      if(cutSel) a.cut = cutSel.value;
      if(!a.cut) a.cut = 'No';
    }
  }

  const idx = animals.findIndex(x => x.id === editingId);
  if(idx === -1){ alert("Could not save (animal missing)."); return; }

  // Preserve photoIds (already in record), but keep draft copy
  if(!Array.isArray(a.photoIds)) a.photoIds = animals[idx].photoIds || [];

  animals[idx] = JSON.parse(JSON.stringify(a));
  saveAll();

  originalDraftSnapshot = JSON.parse(JSON.stringify(a));
  alert("Saved.");
  renderDetail();
}

function promote(){
  if(!draft) return;

  if(hasUnsavedChanges()){
    alert("Please Save Changes before promoting.");
    return;
  }

  if(draft.role === 'calf'){
    if(draft.sex === 'Male'){ alert("Male calves cannot be promoted."); return; }
    if(!confirm("Promote this calf to Heifer? (Sex/Dam/Sire/Description will be locked after promotion.)")) return;

    const idx = animals.findIndex(x => x.id === editingId);
    animals[idx].role = 'heifer';
    animals[idx].lockAfterPromote = true;
    saveAll();

    openDetail(editingId);
    show('heifers');
    return;
  }

  if(draft.role === 'heifer'){
    if(!confirm("Promote this heifer to Cow?")) return;

    const idx = animals.findIndex(x => x.id === editingId);
    animals[idx].role = 'cow';
    saveAll();

    openDetail(editingId);
    show('cows');
    return;
  }
}

function toggleSold(){
  if(!draft) return;

  if(hasUnsavedChanges()){
    alert("Please Save Changes before changing Sold status.");
    return;
  }

  const idx = animals.findIndex(x => x.id === editingId);
  if(idx === -1) return;

  if(!animals[idx].sold){
    if(!confirm("Mark as SOLD? It will move to Sold/History but data stays.")) return;
    animals[idx].sold = true;
  }else{
    if(!confirm("Restore from SOLD? It will return to active lists.")) return;
    animals[idx].sold = false;
  }

  saveAll();
  openDetail(editingId);
}

async function deleteAnimal(){
  if(!draft) return;
  if(!confirm("DELETE permanently? This cannot be undone (including photos).")) return;

  // delete photos
  const ids = Array.isArray(draft.photoIds) ? draft.photoIds : [];
  for(const pid of ids){
    await deletePhotoRecord(pid);
  }

  animals = animals.filter(x => x.id !== editingId);
  saveAll();

  editingId = null;
  draft = null;
  selectedVaxIndex = null;
  originalDraftSnapshot = null;

  show('home');
}

/* =========================
   Modal
========================= */
function openModal(url){
  modalImg.src = url;
  modalOverlay.classList.remove('hidden');
}

/* =========================
   Init
========================= */
async function init(){
  if(!Array.isArray(animals)) animals = [];
  await openPhotoDB(); // ensure db ready
  show('home');
}
init();
</script>
</body>
</html>