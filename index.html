<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cattle Tracker</title>
  <style>
    :root{--bg:#f2f2f2;--card:#fff;--primary:#2e7d32;--secondary:#0277bd;--danger:#c62828;--line:#e5e5e5}
    body{margin:0;padding:15px;font-family:Arial;background:var(--bg)}
    h1{text-align:center;margin:10px 0 6px}
    .sub{text-align:center;color:#555;font-size:12px;margin:0 0 12px}
    button{width:100%;padding:14px;margin:6px 0;font-size:16px;border-radius:10px;border:none;color:#fff}
    .primary{background:var(--primary)}
    .secondary{background:var(--secondary)}
    .danger{background:var(--danger)}
    input,select{width:100%;padding:12px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
    .card{background:var(--card);padding:15px;border-radius:12px;margin-top:12px}
    .hidden{display:none}
    .list{cursor:pointer}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .badge{background:#e8f5e9;padding:8px;border-radius:6px;margin:6px 0}
    .modalBack{
      position:fixed;left:0;top:0;width:100%;height:100%;
      background:rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;
      padding:16px;z-index:9999;
    }
    .modal{
      width:100%;max-width:520px;background:#111;border-radius:14px;overflow:hidden;
      border:1px solid rgba(255,255,255,.2);
    }
    .modalInner{background:#111;color:#fff;padding:10px}
    .modalInner img{width:100%;height:auto;display:block;border-radius:10px}
    .modalBtns{background:#000;padding:10px}
  </style>
</head>
<body>

<h1>üêÑ Cattle Tracker</h1>
<div class="sub">Offline-ready ‚Ä¢ Data & photos stored on this device</div>

<div id="screens">

  <!-- HOME -->
  <div id="home">
    <div class="row">
      <input id="searchTag" placeholder="Search by Tag # (all active)" />
      <button class="secondary" style="max-width:130px" onclick="doSearch()">Search</button>
    </div>
    <button class="primary" onclick="show('calves')">Calves</button>
    <button class="secondary" onclick="show('heifers')">Heifers</button>
    <button class="secondary" onclick="show('cows')">Cows</button>
    <button class="secondary" onclick="show('bulls')">Bulls</button>
    <button class="secondary" onclick="show('sold')">Sold / History</button>
    <button class="danger" onclick="resetAll()">Reset Data (if stuck)</button>
  </div>

  <!-- LISTS -->
  <div id="calves" class="hidden">
    <button class="primary" onclick="show('addCalf')">‚ûï Add Calf</button>
    <div id="calfList"></div>
    <button class="secondary" onclick="show('home')">Back</button>
  </div>

  <div id="heifers" class="hidden">
    <button class="primary" onclick="show('addHeifer')">‚ûï Add Heifer</button>
    <div id="heiferList"></div>
    <button class="secondary" onclick="show('home')">Back</button>
  </div>

  <div id="cows" class="hidden">
    <button class="primary" onclick="show('addCow')">‚ûï Add Cow</button>
    <div id="cowList"></div>
    <button class="secondary" onclick="show('home')">Back</button>
  </div>

  <div id="bulls" class="hidden">
    <button class="primary" onclick="show('addBull')">‚ûï Add Bull</button>
    <div id="bullList"></div>
    <button class="secondary" onclick="show('home')">Back</button>
  </div>

  <div id="sold" class="hidden">
    <h2>Sold / History</h2>
    <div id="soldList"></div>
    <button class="secondary" onclick="show('home')">Back</button>
  </div>

  <!-- ADD SCREENS -->
  <div id="addCalf" class="card hidden">
    <h2>Add Calf</h2>
    <select id="aSex">
      <option value="Female">Female</option>
      <option value="Male">Male</option>
    </select>
    <input id="aTag" placeholder="Tag (optional)">
    <input id="aColor" placeholder="Tag Color (type it)">
    <input id="aDesc" placeholder="Description (Black, Grey, Motley Face, etc)">
    <input type="date" id="aBorn">
    <select id="aDam"></select>
    <select id="aSire"></select>
    <button class="primary" onclick="createAnimal('calf')">Save Calf</button>
    <button class="secondary" onclick="show('calves')">Cancel</button>
  </div>

  <div id="addHeifer" class="card hidden">
    <h2>Add Heifer</h2>
    <input id="hTag" placeholder="Tag (optional)">
    <input id="hColor" placeholder="Tag Color (type it)">
    <input id="hDesc" placeholder="Description (Black, Grey, Motley Face, etc)">
    <input type="date" id="hBorn">
    <button class="primary" onclick="createAnimal('heifer')">Save Heifer</button>
    <button class="secondary" onclick="show('heifers')">Cancel</button>
  </div>

  <div id="addCow" class="card hidden">
    <h2>Add Cow</h2>
    <input id="cTag" placeholder="Tag">
    <input id="cColor" placeholder="Tag Color (type it)">
    <input id="cDesc" placeholder="Description (Black, Grey, Motley Face, etc)">
    <input type="date" id="cBorn">
    <button class="primary" onclick="createAnimal('cow')">Save Cow</button>
    <button class="secondary" onclick="show('cows')">Cancel</button>
  </div>

  <div id="addBull" class="card hidden">
    <h2>Add Bull</h2>
    <input id="bTag" placeholder="Bull # (ex: 25)">
    <input id="bDesc" placeholder="Description (optional)">
    <button class="primary" onclick="createAnimal('bull')">Save Bull</button>
    <button class="secondary" onclick="show('bulls')">Cancel</button>
  </div>

  <!-- DETAIL -->
  <div id="detail" class="card hidden"></div>

</div>

<!-- PHOTO MODAL (SAFE: starts hidden, never opened on load) -->
<div id="photoModal" class="modalBack hidden" onclick="closePhoto(event)">
  <div class="modal" onclick="event.stopPropagation()">
    <div class="modalInner">
      <img id="modalImg" alt="photo" />
    </div>
    <div class="modalBtns">
      <button class="secondary" onclick="closePhoto()">Close</button>
    </div>
  </div>
</div>

<script>
/*** STORAGE ***/
let animals = JSON.parse(localStorage.getItem("animals") || "[]"); // calves/heifers/cows/bulls all together
let editing = null;
let dirty = false;

function saveAll(){
  localStorage.setItem("animals", JSON.stringify(animals));
}

function resetAll(){
  if(!confirm("Reset all saved data on this device?")) return;
  localStorage.removeItem("animals");
  animals = [];
  editing = null;
  dirty = false;
  closePhoto();
  show("home");
}

/*** UI NAV ***/
function show(id){
  // prevent backing out with unsaved edits
  if(editing && dirty && id !== "detail"){
    if(!confirm("You have unsaved changes. Leave without saving?")) return;
    dirty = false;
  }
  document.querySelectorAll("#screens > div").forEach(d => d.classList.add("hidden"));
  document.getElementById(id).classList.remove("hidden");
  refresh();
}

function refresh(){
  // lists
  calfList.innerHTML = listHtml("calf");
  heiferList.innerHTML = listHtml("heifer");
  cowList.innerHTML = listHtml("cow");
  bullList.innerHTML = listHtml("bull");
  soldList.innerHTML = animals.filter(a=>a.sold).map(a=>`
    <div class="card">
      ${a.role.toUpperCase()} | Tag ${escape(a.tag || "‚Äî")} | ${escape(a.desc||"")}
    </div>
  `).join("") || `<div class="card">No sold/history yet.</div>`;

  // dropdowns for adding calf
  aDam.innerHTML = `<option value="">Select Cow (Dam) (optional)</option>` +
    animals.filter(a=>a.role==="cow" && !a.sold).map(c=>`<option value="${c.id}">${escape(c.tag||"Cow")} ‚Äî ${escape(c.desc||"")}</option>`).join("");
  aSire.innerHTML = `<option value="">Select Bull (Sire) (optional)</option>` +
    animals.filter(a=>a.role==="bull" && !a.sold).map(b=>`<option value="${b.id}">${escape(b.tag||"Bull")} ‚Äî ${escape(b.desc||"")}</option>`).join("");
}

function listHtml(role){
  const active = animals.filter(a=>a.role===role && !a.sold);
  if(!active.length) return `<div class="card">None yet.</div>`;
  return active.map(a=>`
    <div class="card list" onclick="openAnimal(${a.id})">
      ${role.toUpperCase()} | Tag ${escape(a.tag||"‚Äî")} | ${escape(a.desc||"")}
    </div>
  `).join("");
}

/*** CREATE ***/
function createAnimal(role){
  const nowId = Date.now();

  if(role==="calf"){
    const sex = aSex.value;
    animals.push({
      id: nowId,
      role: "calf",
      sex,
      tag: aTag.value.trim(),
      color: aColor.value.trim(),
      desc: aDesc.value.trim(),
      born: aBorn.value || "",
      damId: aDam.value || "",
      sireId: aSire.value || "",
      cut: (sex==="Male") ? "No" : "",
      vaccines: [],
      photos: [],
      sold: false
    });
    saveAll();
    show("calves");
    return;
  }

  if(role==="heifer"){
    animals.push({
      id: nowId,
      role: "heifer",
      sex: "Female",
      tag: hTag.value.trim(),
      color: hColor.value.trim(),
      desc: hDesc.value.trim(),
      born: hBorn.value || "",
      damId: "",
      sireId: "",
      cut: "",
      vaccines: [],
      photos: [],
      sold: false
    });
    saveAll();
    show("heifers");
    return;
  }

  if(role==="cow"){
    animals.push({
      id: nowId,
      role: "cow",
      sex: "Female",
      tag: cTag.value.trim(),
      color: cColor.value.trim(),
      desc: cDesc.value.trim(),
      born: cBorn.value || "",
      vaccines: [],
      photos: [],
      sold: false
    });
    saveAll();
    show("cows");
    return;
  }

  if(role==="bull"){
    animals.push({
      id: nowId,
      role: "bull",
      sex: "Male",
      tag: bTag.value.trim(),
      color: "",
      desc: bDesc.value.trim(),
      born: "",
      vaccines: [],
      photos: [],
      sold: false
    });
    saveAll();
    show("bulls");
    return;
  }
}

/*** SEARCH ***/
function doSearch(){
  const q = (searchTag.value||"").trim().toLowerCase();
  if(!q){ alert("Enter a tag number to search."); return; }
  const found = animals.find(a => !a.sold && (a.tag||"").toLowerCase() === q);
  if(!found){ alert("No active animal found with that tag."); return; }
  openAnimal(found.id);
}

/*** DETAIL VIEW / EDIT ***/
function openAnimal(id){
  const a = animals.find(x=>x.id===id);
  if(!a) return;

  editing = JSON.parse(JSON.stringify(a));
  dirty = false;

  // linked names
  const dam = editing.damId ? animals.find(x=>String(x.id)===String(editing.damId)) : null;
  const sire = editing.sireId ? animals.find(x=>String(x.id)===String(editing.sireId)) : null;

  // calves for a cow (relationship by damId)
  const cowCalves = (editing.role==="cow")
    ? animals.filter(x => (x.role==="calf" || x.role==="heifer" || x.role==="cow") && String(x.damId||"")===String(editing.id) )
    : [];

  // build vaccine list
  const vHtml = (editing.vaccines||[]).length
    ? editing.vaccines.map((v,idx)=>`
        <div class="badge">
          <b>${escape(v.date||"")}</b>${v.note?` ‚Äî ${escape(v.note)}`:""}
          <div class="row">
            <button class="secondary" onclick="editVax(${idx})">Edit</button>
            <button class="danger" onclick="delVax(${idx})">Delete</button>
          </div>
        </div>
      `).join("")
    : `<div class="badge">None</div>`;

  // build photo list (inside animal only)
  const pHtml = (editing.photos||[]).length
    ? editing.photos.map((src,idx)=>`
        <div class="badge">
          Photo ${idx+1}
          <div class="row">
            <button class="secondary" onclick="viewPhoto(${idx})">View</button>
            <button class="danger" onclick="delPhoto(${idx})">Delete</button>
          </div>
        </div>
      `).join("")
    : `<div class="badge">None</div>`;

  // dam/sire dropdowns for editing (only for calves/heifers/cows)
  const damSelect = `
    <select id="eDam" onchange="markDirty()">
      <option value="">(No Dam selected)</option>
      ${animals.filter(x=>x.role==="cow" && !x.sold).map(c=>`
        <option value="${c.id}" ${String(editing.damId||"")==String(c.id)?"selected":""}>
          ${escape(c.tag||"Cow")} ‚Äî ${escape(c.desc||"")}
        </option>
      `).join("")}
    </select>
  `;

  const sireSelect = `
    <select id="eSire" onchange="markDirty()">
      <option value="">(No Sire selected)</option>
      ${animals.filter(x=>x.role==="bull" && !x.sold).map(b=>`
        <option value="${b.id}" ${String(editing.sireId||"")==String(b.id)?"selected":""}>
          ${escape(b.tag||"Bull")} ‚Äî ${escape(b.desc||"")}
        </option>
      `).join("")}
    </select>
  `;

  const roleTitle = editing.role.toUpperCase();

  detail.innerHTML = `
    <h2>${roleTitle}</h2>

    <div class="badge">
      <div><b>Sex:</b> ${escape(editing.sex||"")}${(editing.role!=="calf")?` (locked)`:""}</div>
      <div><b>Status:</b> ${editing.sold ? "SOLD" : "ACTIVE"}</div>
    </div>

    Tag:
    <input id="eTag" value="${escapeAttr(editing.tag||"")}" oninput="markDirty()">

    Tag Color:
    <input id="eColor" value="${escapeAttr(editing.color||"")}" oninput="markDirty()">

    Description:
    <input id="eDesc" value="${escapeAttr(editing.desc||"")}" oninput="markDirty()">

    Born:
    <input type="date" id="eBorn" value="${escapeAttr(editing.born||"")}" oninput="markDirty()">

    ${(editing.role==="calf" || editing.role==="heifer") ? `
      Cow (Dam):
      ${damSelect}
      Bull (Sire):
      ${sireSelect}
      <div class="badge">
        <b>Currently:</b><br>
        Dam: ${dam ? escape(dam.tag||"Cow")+" ‚Äî "+escape(dam.desc||"") : "Unknown"}<br>
        Sire: ${sire ? escape(sire.tag||"Bull")+" ‚Äî "+escape(sire.desc||"") : "Unknown"}
      </div>
    ` : ""}

    ${(editing.sex==="Male") ? `
      Cut:
      <select id="eCut" onchange="markDirty()">
        <option value="No" ${editing.cut==="No"?"selected":""}>No</option>
        <option value="Yes" ${editing.cut==="Yes"?"selected":""}>Yes</option>
      </select>
    ` : ""}

    ${(editing.role==="cow") ? `
      <h3>Calves Produced</h3>
      ${cowCalves.length ? cowCalves.map(x=>`
        <div class="badge">
          ${escape(x.role.toUpperCase())} | Tag ${escape(x.tag||"‚Äî")} | ${escape(x.sex||"")}
        </div>
      `).join("") : `<div class="badge">None linked yet.</div>`}
    ` : ""}

    <h3>Vaccines</h3>
    ${vHtml}
    <div class="badge">
      <b>Add Vaccine</b>
      <input type="date" id="newVDate" onchange="markDirty()">
      <input id="newVNote" placeholder="Vaccine note (optional)" oninput="markDirty()">
      <button class="secondary" onclick="addVax()">Add Vaccine</button>
    </div>

    <h3>Photos</h3>
    ${pHtml}
    <div class="badge">
      <b>Add Photo</b>
      <input type="file" id="photoFile" accept="image/*" onchange="addPhoto(this.files)">
    </div>

    <button class="primary" onclick="saveEdits()">Save Changes</button>

    ${(editing.role==="calf" && editing.sex==="Female") ? `
      <button class="secondary" onclick="promote()">Promote to Heifer</button>
    ` : ""}

    ${(editing.role==="heifer") ? `
      <button class="secondary" onclick="promote()">Promote to Cow</button>
    ` : ""}

    ${(!editing.sold) ? `<button class="danger" onclick="markSold()">Mark Sold</button>` : ""}

    <button class="danger" onclick="deleteAnimal()">Delete</button>
    <button class="secondary" onclick="backFromDetail()">Back</button>
  `;

  show("detail");
}

function markDirty(){ dirty = true; }

function backFromDetail(){
  // go back to the correct list
  const map = {calf:"calves", heifer:"heifers", cow:"cows", bull:"bulls"};
  show(map[editing.role] || "home");
}

/*** SAVE / DELETE / SOLD / PROMOTE ***/
function saveEdits(){
  const i = animals.findIndex(x=>x.id===editing.id);
  if(i<0) return;

  // apply edits from form
  const role = animals[i].role; // original role in storage

  animals[i].tag  = document.getElementById("eTag").value.trim();
  animals[i].color= document.getElementById("eColor").value.trim();
  animals[i].desc = document.getElementById("eDesc").value.trim();
  animals[i].born = document.getElementById("eBorn").value || "";

  if(role==="calf" || role==="heifer"){
    animals[i].damId = document.getElementById("eDam")?.value || "";
    animals[i].sireId= document.getElementById("eSire")?.value || "";
  }

  if(animals[i].sex==="Male"){
    animals[i].cut = document.getElementById("eCut")?.value || "No";
  }

  // vaccines/photos live in editing object updates; sync them
  animals[i].vaccines = editing.vaccines || [];
  animals[i].photos   = editing.photos || [];

  saveAll();
  dirty = false;
  alert("Saved!");
  backFromDetail();
}

function deleteAnimal(){
  if(!confirm("Delete this animal? This cannot be undone.")) return;
  animals = animals.filter(x=>x.id!==editing.id);

  // also unlink calves that referenced it as dam/sire
  animals.forEach(x=>{
    if(String(x.damId||"")===String(editing.id)) x.damId = "";
    if(String(x.sireId||"")===String(editing.id)) x.sireId = "";
  });

  saveAll();
  editing = null;
  dirty = false;
  show("home");
}

function markSold(){
  if(!confirm("Mark as sold? It will move to Sold/History but stay saved.")) return;
  const i = animals.findIndex(x=>x.id===editing.id);
  if(i<0) return;
  animals[i].sold = true;
  saveAll();
  editing = null;
  dirty = false;
  show("sold");
}

function promote(){
  const i = animals.findIndex(x=>x.id===editing.id);
  if(i<0) return;

  if(animals[i].role==="calf"){
    if(animals[i].sex!=="Female"){ alert("Only female calves can be promoted."); return; }
    if(!confirm("Promote this CALF to HEIFER?")) return;
    animals[i].role = "heifer";
    // keep everything (tag/color/desc/vaccines/photos/dam/sire)
    saveAll();
    editing = null;
    dirty = false;
    show("heifers");
    return;
  }

  if(animals[i].role==="heifer"){
    if(!confirm("Promote this HEIFER to COW?")) return;
    animals[i].role = "cow";
    // once cow, dam/sire fields are no longer shown/edited
    saveAll();
    editing = null;
    dirty = false;
    show("cows");
    return;
  }
}

/*** VACCINES (EDIT/DELETE) ***/
function addVax(){
  const d = document.getElementById("newVDate").value;
  const n = document.getElementById("newVNote").value.trim();
  if(!d){ alert("Pick a vaccine date."); return; }
  if(!editing.vaccines) editing.vaccines = [];
  editing.vaccines.push({date:d, note:n});
  dirty = true;
  openAnimal(editing.id);
}

function editVax(idx){
  const v = editing.vaccines[idx];
  const nd = prompt("Edit vaccine date (YYYY-MM-DD):", v.date || "");
  if(nd===null) return;
  const nn = prompt("Edit note (optional):", v.note || "");
  if(nn===null) return;
  editing.vaccines[idx] = {date: (nd||"").trim(), note: (nn||"").trim()};
  dirty = true;
  openAnimal(editing.id);
}

function delVax(idx){
  if(!confirm("Delete this vaccine entry?")) return;
  editing.vaccines.splice(idx,1);
  dirty = true;
  openAnimal(editing.id);
}

/*** PHOTOS (MULTIPLE, INSIDE ANIMAL ONLY) ***/
function addPhoto(fileList){
  if(!fileList || !fileList.length) return;
  const file = fileList[0];
  const reader = new FileReader();
  reader.onload = () => {
    if(!editing.photos) editing.photos = [];
    editing.photos.push(reader.result); // base64 data URL
    dirty = true;
    openAnimal(editing.id);
  };
  reader.readAsDataURL(file);
}

function viewPhoto(idx){
  const src = (editing.photos||[])[idx];
  if(!src) return;
  modalImg.src = src;
  photoModal.classList.remove("hidden");
}

function delPhoto(idx){
  if(!confirm("Delete this photo?")) return;
  editing.photos.splice(idx,1);
  dirty = true;
  openAnimal(editing.id);
}

function closePhoto(){
  photoModal.classList.add("hidden");
  modalImg.src = "";
}

/*** HELPERS ***/
function escape(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function escapeAttr(s){ return escape(s).replace(/"/g,'&quot;'); }

/// Safe boot: always hide modal
closePhoto();
show("home");
</script>

</body>
</html>